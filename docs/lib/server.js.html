<!DOCTYPE html><html><head><title>server.js</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../index.html" class="source"><span class="file_name">README</span></a><a href="../lib/client.js.html" class="source "><span class="base_path">lib / </span><span class="file_name">client.js</span></a><a href="../lib/errorcode.js.html" class="source "><span class="base_path">lib / </span><span class="file_name">errorcode.js</span></a><a href="../lib/index.js.html" class="source "><span class="base_path">lib / </span><span class="file_name">index.js</span></a><a href="../lib/server.js.html" class="source selected"><span class="base_path">lib / </span><span class="file_name">server.js</span></a><a href="../lib/transports/client/http.js.html" class="source "><span class="base_path">lib / transports / client / </span><span class="file_name">http.js</span></a><a href="../lib/transports/client/tcp.js.html" class="source "><span class="base_path">lib / transports / client / </span><span class="file_name">tcp.js</span></a><a href="../lib/transports/client/childProcess.js.html" class="source "><span class="base_path">lib / transports / client / </span><span class="file_name">childProcess.js</span></a><a href="../lib/transports/server/http.js.html" class="source "><span class="base_path">lib / transports / server / </span><span class="file_name">http.js</span></a><a href="../lib/transports/server/middleware.js.html" class="source "><span class="base_path">lib / transports / server / </span><span class="file_name">middleware.js</span></a><a href="../lib/transports/server/tcp.js.html" class="source "><span class="base_path">lib / transports / server / </span><span class="file_name">tcp.js</span></a><a href="../lib/transports/server/childProcess.js.html" class="source "><span class="base_path">lib / transports / server / </span><span class="file_name">childProcess.js</span></a><a href="../lib/transports/shared/loopback.js.html" class="source "><span class="base_path">lib / transports / shared / </span><span class="file_name">loopback.js</span></a><a href="../lib/transports/shared/tcp.js.html" class="source "><span class="base_path">lib / transports / shared / </span><span class="file_name">tcp.js</span></a><a href="../test/child/child-compressed.js.html" class="source "><span class="base_path">test / child / </span><span class="file_name">child-compressed.js</span></a><a href="../test/child/child.js.html" class="source "><span class="base_path">test / child / </span><span class="file_name">child.js</span></a><a href="../test/client-childProccess-compressed.js.html" class="source "><span class="base_path">test / </span><span class="file_name">client-childProccess-compressed.js</span></a><a href="../test/client-childProccess.js.html" class="source "><span class="base_path">test / </span><span class="file_name">client-childProccess.js</span></a><a href="../test/client-http.js.html" class="source "><span class="base_path">test / </span><span class="file_name">client-http.js</span></a><a href="../test/client-tcp.js.html" class="source "><span class="base_path">test / </span><span class="file_name">client-tcp.js</span></a><a href="../test/client.js.html" class="source "><span class="base_path">test / </span><span class="file_name">client.js</span></a><a href="../test/full-stack.js.html" class="source "><span class="base_path">test / </span><span class="file_name">full-stack.js</span></a><a href="../test/server-http.js.html" class="source "><span class="base_path">test / </span><span class="file_name">server-http.js</span></a><a href="../test/server-tcp.js.html" class="source "><span class="base_path">test / </span><span class="file_name">server-tcp.js</span></a><a href="../test/server.js.html" class="source "><span class="base_path">test / </span><span class="file_name">server.js</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>server.js</h1><div class="filepath">lib/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div>
</td><td class="code"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">errorCode</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./errorcode&#39;</span><span class="p">)</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><h2>The JSONRPC constructor</h2>

<p>Each JSON-RPC object is tied to a <em>scope</em>, an object containing functions to
call. If not passed an explicit scope, <em>Node.js</em>' <em>root</em> scope will be used.
Also, unlike the Javascript running in web browsers, functions not explicitly
assigned to a scope are attached to the anonymous scope block only and cannot
be accessed even from the <em>root</em> scope.</p>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">JSONRPC</span><span class="p">(</span><span class="nx">transports</span><span class="p">,</span> <span class="nx">scope</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">transports</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">transports</span><span class="p">)</span> <span class="o">?</span> <span class="nx">transports</span> <span class="o">:</span> <span class="p">[</span><span class="nx">transports</span><span class="p">]</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">transport</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">transports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">// For compatibility with existing code</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">scope</span> <span class="o">=</span> <span class="nx">scope</span></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>The actual object initialization occurs here. If the <em>scope</em> is not
defined, the <em>root</em> scope is used, and then the object is returned to
the developer.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">scope</span> <span class="o">||</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">scope</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>global root: false</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">scope</span> <span class="o">=</span> <span class="nx">root</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><h3>The <em>rpc.methodList</em> method</h3>

<p>is a JSON-RPC extension that returns a list of all methods in the scope</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">scope</span><span class="p">[</span><span class="s1">&#39;rpc.methodList&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">scope</span><span class="p">))</span>
  <span class="p">}</span>

  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">transports</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">transports</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">handler</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleJSON</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="k">this</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><h3>The <em>handleJSON</em> function</h3>

<p>makes up the majority of the JSON-RPC server logic, handling the requests
from clients, passing the call to the correct function, catching any
errors the function may throw, and calling the function to return the
results back to the client.</p>
</td><td class="code"><div class="highlight"><pre><span class="nx">JSONRPC</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">handleJSON</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">handleJSON</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">function</span> <span class="nx">setDefaultProperty</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">outObj</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;jsonrpc&#39;</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">outObj</span><span class="p">.</span><span class="nx">jsonrpc</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">jsonrpc</span>
    <span class="p">}</span>
    <span class="nx">outObj</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">data</span><span class="p">.</span><span class="nx">id</span> <span class="o">:</span> <span class="kc">undefined</span>
    <span class="k">return</span> <span class="nx">outObj</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">batchCallback</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">handleJSON</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">batchCallback</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">len</span><span class="p">))</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">data</span> <span class="k">instanceof</span> <span class="nb">Object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">method</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>If the method is defined in the scope and is not marked as a
blocking function, then a callback must be defined for
the function. The callback takes two parameters: the
<em>result</em> of the function, and an <em>error</em> message.</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">arglen</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">params</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">params</span> <span class="k">instanceof</span> <span class="nb">Array</span> <span class="o">?</span> <span class="nx">data</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">length</span> <span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">params</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span>
      <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scope</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">method</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scope</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">method</span><span class="p">].</span><span class="nx">length</span> <span class="o">===</span> <span class="nx">arglen</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">scope</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">method</span><span class="p">].</span><span class="nx">blocking</span><span class="p">))</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">next</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">outObj</span> <span class="o">=</span> <span class="nx">setDefaultProperty</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
          <span class="k">if</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">error</span> <span class="k">instanceof</span> <span class="nb">Error</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">outObj</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="p">{}</span>
              <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span>
              <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
                <span class="nx">outObj</span><span class="p">.</span><span class="nx">error</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">error</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
              <span class="p">}</span>
              <span class="nx">outObj</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">code</span> <span class="o">=</span> <span class="nx">errorCode</span><span class="p">.</span><span class="nx">internalError</span>
              <span class="nx">outObj</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="nx">outObj</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="nx">error</span>
            <span class="p">}</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">outObj</span><span class="p">.</span><span class="nx">result</span> <span class="o">=</span> <span class="nx">result</span>
          <span class="p">}</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">outObj</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">params</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">data</span><span class="p">.</span><span class="nx">params</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">params</span> <span class="o">?</span> <span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">params</span><span class="p">]</span> <span class="o">:</span> <span class="p">[]</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">paramsMissing</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">scope</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">method</span><span class="p">].</span><span class="nx">length</span> <span class="o">-</span> <span class="p">(</span><span class="nx">arglen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">paramsMissing</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">data</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kc">undefined</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="nx">data</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>This <em>try-catch</em> block is for catching errors in an asynchronous server method.
Since the async methods are supposed to return an error in the callback, this
is assumed to be an unintended mistake, so we catch the error, send a JSON-RPC
error response, and then re-throw the error so the server code gets the error
and can deal with it appropriately (which could be "crash because this isn't
expected to happen").</p>
</td><td class="code"><div class="highlight"><pre>        <span class="k">try</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">scope</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">method</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">params</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">outErr</span> <span class="o">=</span> <span class="p">{}</span>
          <span class="nx">outErr</span><span class="p">.</span><span class="nx">code</span> <span class="o">=</span> <span class="nx">errorCode</span><span class="p">.</span><span class="nx">internalError</span>
          <span class="nx">outErr</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">message</span> <span class="o">?</span> <span class="nx">e</span><span class="p">.</span><span class="nx">message</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span>
          <span class="nx">outErr</span><span class="p">.</span><span class="nx">stack</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">stack</span> <span class="o">?</span> <span class="nx">e</span><span class="p">.</span><span class="nx">stack</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span>
          <span class="kd">var</span> <span class="nx">outObj</span> <span class="o">=</span> <span class="nx">setDefaultProperty</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
          <span class="nx">outObj</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="nx">outErr</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">outObj</span><span class="p">)</span>
          <span class="k">throw</span> <span class="nx">e</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">errObj1</span> <span class="o">=</span> <span class="nx">setDefaultProperty</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
        <span class="nx">errObj1</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">code</span><span class="o">:</span> <span class="nx">errorCode</span><span class="p">.</span><span class="nx">methodNotFound</span><span class="p">,</span>
          <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Requested method does not exist.&#39;</span>
        <span class="p">}</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">errObj1</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">errObj2</span> <span class="o">=</span> <span class="nx">setDefaultProperty</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
      <span class="nx">errObj2</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">code</span><span class="o">:</span> <span class="nx">errorCode</span><span class="p">.</span><span class="nx">invalidRequest</span><span class="p">,</span>
        <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Did not receive valid JSON-RPC data.&#39;</span>
      <span class="p">}</span>
      <span class="nx">callback</span><span class="p">(</span><span class="nx">errObj2</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">errObj3</span> <span class="o">=</span> <span class="nx">setDefaultProperty</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
    <span class="nx">errObj3</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">code</span><span class="o">:</span> <span class="nx">errorCode</span><span class="p">.</span><span class="nx">parseError</span><span class="p">,</span>
      <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Did not receive valid JSON-RPC data.&#39;</span>
    <span class="p">}</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">errObj3</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><h3>The <em>register</em> function</h3>

<p>allows one to attach a function to the current scope after the scope has
been attached to the JSON-RPC server, for similar possible shenanigans as
described above. This method in particular, though, by attaching new
functions to the current scope, could be used for caching purposes or
self-modifying code that rewrites its own definition.</p>
</td><td class="code"><div class="highlight"><pre><span class="nx">JSONRPC</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">register</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">methodName</span><span class="p">,</span> <span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">scope</span> <span class="o">||</span> <span class="k">typeof</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scope</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">scope</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">scope</span><span class="p">[</span><span class="nx">methodName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">method</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>Make a <code>blocking</code> helper method to async-ify them</p>
</td><td class="code"><div class="highlight"><pre><span class="nx">JSONRPC</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">blocking</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">blocking</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="nx">blocked</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="kd">var</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">res</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">res</span> <span class="o">=</span> <span class="nx">func</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">err</span> <span class="o">=</span> <span class="nx">e</span> <span class="c1">// Doesn&#39;t throw because it&#39;s the only way to return an error with sync methods</span>
    <span class="p">}</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>Cleanly shut down the JSONRPC server</p>
</td><td class="code"><div class="highlight"><pre><span class="nx">JSONRPC</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">shutdown</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">shutdown</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">closed</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="kd">var</span> <span class="nx">transports</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">transports</span>
  <span class="nx">transports</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">transport</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">transport</span><span class="p">.</span><span class="nx">shutdown</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">closed</span><span class="o">++</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">closed</span> <span class="o">===</span> <span class="nx">transports</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">done</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="nx">done</span><span class="p">()</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>Export the server constructor</p>
</td><td class="code"><div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">JSONRPC</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Thu Sep 13 2018 10:16:48 GMT-0700 (PDT)  </div></div></body></html>