<!DOCTYPE html><html><head><title>client.js</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../index.html" class="source"><span class="file_name">README</span></a><a href="../lib/client.js.html" class="source selected"><span class="base_path">lib / </span><span class="file_name">client.js</span></a><a href="../lib/errorcode.js.html" class="source "><span class="base_path">lib / </span><span class="file_name">errorcode.js</span></a><a href="../lib/index.js.html" class="source "><span class="base_path">lib / </span><span class="file_name">index.js</span></a><a href="../lib/server.js.html" class="source "><span class="base_path">lib / </span><span class="file_name">server.js</span></a><a href="../lib/transports/client/http.js.html" class="source "><span class="base_path">lib / transports / client / </span><span class="file_name">http.js</span></a><a href="../lib/transports/client/tcp.js.html" class="source "><span class="base_path">lib / transports / client / </span><span class="file_name">tcp.js</span></a><a href="../lib/transports/client/childProcess.js.html" class="source "><span class="base_path">lib / transports / client / </span><span class="file_name">childProcess.js</span></a><a href="../lib/transports/server/http.js.html" class="source "><span class="base_path">lib / transports / server / </span><span class="file_name">http.js</span></a><a href="../lib/transports/server/middleware.js.html" class="source "><span class="base_path">lib / transports / server / </span><span class="file_name">middleware.js</span></a><a href="../lib/transports/server/tcp.js.html" class="source "><span class="base_path">lib / transports / server / </span><span class="file_name">tcp.js</span></a><a href="../lib/transports/server/childProcess.js.html" class="source "><span class="base_path">lib / transports / server / </span><span class="file_name">childProcess.js</span></a><a href="../lib/transports/shared/loopback.js.html" class="source "><span class="base_path">lib / transports / shared / </span><span class="file_name">loopback.js</span></a><a href="../lib/transports/shared/tcp.js.html" class="source "><span class="base_path">lib / transports / shared / </span><span class="file_name">tcp.js</span></a><a href="../test/child/child-compressed.js.html" class="source "><span class="base_path">test / child / </span><span class="file_name">child-compressed.js</span></a><a href="../test/child/child.js.html" class="source "><span class="base_path">test / child / </span><span class="file_name">child.js</span></a><a href="../test/client-childProccess-compressed.js.html" class="source "><span class="base_path">test / </span><span class="file_name">client-childProccess-compressed.js</span></a><a href="../test/client-childProccess.js.html" class="source "><span class="base_path">test / </span><span class="file_name">client-childProccess.js</span></a><a href="../test/client-http.js.html" class="source "><span class="base_path">test / </span><span class="file_name">client-http.js</span></a><a href="../test/client-tcp.js.html" class="source "><span class="base_path">test / </span><span class="file_name">client-tcp.js</span></a><a href="../test/client.js.html" class="source "><span class="base_path">test / </span><span class="file_name">client.js</span></a><a href="../test/full-stack.js.html" class="source "><span class="base_path">test / </span><span class="file_name">full-stack.js</span></a><a href="../test/server-http.js.html" class="source "><span class="base_path">test / </span><span class="file_name">server-http.js</span></a><a href="../test/server-tcp.js.html" class="source "><span class="base_path">test / </span><span class="file_name">server-tcp.js</span></a><a href="../test/server.js.html" class="source "><span class="base_path">test / </span><span class="file_name">server.js</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>client.js</h1><div class="filepath">lib/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div><h2>The JSONRPC constructor</h2>

<p>Each JSON-RPC object created is tied to a particular JSON-RPC server URL.
This may be inconvenient for server architectures that have many URLs for
each JSON-RPC server, but this is an odd use case we aren't implementing.</p>

<p>The constructed JSON-RPC objects consist of three built-in methods:</p>

<ul>
<li>request</li>
<li>register</li>
</ul>

<p>The <em>request</em> and <em>requestBlock</em> functions are the ones actually used to
call the JSON-RPC server, and the <em>register</em> function constructs the expected
function names to be used by the developer using this JSON-RPC client.</p>
</td><td class="code"><div class="highlight"><pre><span></span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>The JSONRPC constructor <em>must</em> receive a server URL on initialization</p>
</td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">JSONRPC</span><span class="p">(</span><span class="nx">transport</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">transport</span> <span class="o">=</span> <span class="nx">transport</span></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>Parse any <em>options</em> provided to the client
If no <em>options</em> object provided, create an empty one</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;object&#39;</span> <span class="o">||</span> <span class="nx">options</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">options</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><p>add custom request id generator if provided in options</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;idGenerator&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">idGenerator</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">idGenerator</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">idGenerator</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>default</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">else</span> <span class="k">this</span><span class="p">.</span><span class="nx">idGenerator</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p><em>autoRegister</em> methods from the server unless explicitly told otherwise</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;autoRegister&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">options</span><span class="p">.</span><span class="nx">autoRegister</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="s1">&#39;rpc.methodList&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="nx">done</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">))</span>
  <span class="p">}</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>Once the JSONRPC object has been properly initialized, return the object
to the developer</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">return</span> <span class="k">this</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><h3>The <em>request</em> function</h3>

<p>is a non-blocking function that takes an arbitrary number of arguments,
where the first argument is the remote method name to execute, the last
argument is the callback function to execute when the server returns its
results, and all of the arguments in between are the values passed to the
remote method.</p>
</td><td class="code"><div class="highlight"><pre><span class="nx">JSONRPC</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">request</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>The <em>contents</em> variable contains the JSON-RPC 1.0 POST string.</p>
</td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">requestId</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">idGenerator</span><span class="p">()</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">requestId</span> <span class="o">||</span> <span class="nx">requestId</span> <span class="o">===</span>  <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">callback</span> <span class="k">instanceof</span> <span class="nb">Function</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Request id generator function should return an id&#39;</span><span class="p">))</span>
      <span class="k">return</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">contents</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">method</span><span class="o">:</span> <span class="nx">method</span><span class="p">,</span>
    <span class="nx">params</span><span class="o">:</span> <span class="nx">args</span><span class="p">,</span>
    <span class="nx">id</span><span class="o">:</span> <span class="nx">requestId</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">contents</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">response</span> <span class="o">&amp;&amp;</span> <span class="nx">callback</span> <span class="k">instanceof</span> <span class="nb">Function</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Server did not return valid JSON-RPC response&#39;</span><span class="p">))</span>
      <span class="k">return</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">callback</span> <span class="k">instanceof</span> <span class="nb">Function</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">response</span> <span class="k">instanceof</span> <span class="nb">Error</span><span class="p">){</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">err</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">)</span>
          <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">error</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">key</span> <span class="o">!==</span> <span class="s1">&#39;message&#39;</span><span class="p">)</span> <span class="nx">err</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">error</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
          <span class="p">})</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">response</span><span class="p">.</span><span class="nx">error</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">error</span><span class="p">))</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">callback</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">result</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><h3>The <em>register</em> function</h3>

<p>is a simple blocking function that takes a method name or array of
method names and directly modifies the</p>
</td><td class="code"><div class="highlight"><pre><span class="nx">JSONRPC</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">register</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">methods</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">methods</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">methods</span> <span class="o">=</span> <span class="p">[</span><span class="nx">methods</span><span class="p">]</span>
  <span class="p">}</span>
  <span class="nx">methods</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">method</span> <span class="o">!==</span> <span class="s1">&#39;transport&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">method</span> <span class="o">!==</span> <span class="s1">&#39;request&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">method</span> <span class="o">!==</span> <span class="s1">&#39;register&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">method</span> <span class="o">!==</span> <span class="s1">&#39;shutdown&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">[</span><span class="nx">method</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">theArgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">theArgs</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">theArgs</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">))</span>
<span class="p">}</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>Cleanly shutdown the JSONRPC client</p>
</td><td class="code"><div class="highlight"><pre><span class="nx">JSONRPC</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">shutdown</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">shutdown</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">JSONRPC</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Tue Aug 28 2018 23:28:48 GMT-0700 (PDT)  </div></div></body></html>